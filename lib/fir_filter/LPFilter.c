#include <stdint.h>
#include "LPFilter.h"

static int filter_taps[LPFILTER_TAP_NUM] = {
  -20,
  -4,
  52,
  190,
  432,
  772,
  1163,
  1513,
  1706,
  1640,
  1269,
  637,
  -112,
  -770,
  -1126,
  -1052,
  -558,
  183,
  891,
  1270,
  1134,
  494,
  -423,
  -1246,
  -1605,
  -1293,
  -375,
  810,
  1765,
  2038,
  1433,
  121,
  -1388,
  -2441,
  -2515,
  -1469,
  348,
  2204,
  3268,
  2975,
  1312,
  -1116,
  -3295,
  -4215,
  -3329,
  -849,
  2271,
  4685,
  5229,
  3462,
  -54,
  -3906,
  -6385,
  -6222,
  -3217,
  1562,
  6132,
  8393,
  7072,
  2384,
  -3902,
  -9098,
  -10715,
  -7608,
  -651,
  7431,
  13077,
  13400,
  7575,
  -2532,
  -12859,
  -18685,
  -16660,
  -6505,
  8410,
  21999,
  27702,
  21296,
  3146,
  -21055,
  -41572,
  -47667,
  -31430,
  8940,
  67685,
  132513,
  187925,
  219814,
  219814,
  187925,
  132513,
  67685,
  8940,
  -31430,
  -47667,
  -41572,
  -21055,
  3146,
  21296,
  27702,
  21999,
  8410,
  -6505,
  -16660,
  -18685,
  -12859,
  -2532,
  7575,
  13400,
  13077,
  7431,
  -651,
  -7608,
  -10715,
  -9098,
  -3902,
  2384,
  7072,
  8393,
  6132,
  1562,
  -3217,
  -6222,
  -6385,
  -3906,
  -54,
  3462,
  5229,
  4685,
  2271,
  -849,
  -3329,
  -4215,
  -3295,
  -1116,
  1312,
  2975,
  3268,
  2204,
  348,
  -1469,
  -2515,
  -2441,
  -1388,
  121,
  1433,
  2038,
  1765,
  810,
  -375,
  -1293,
  -1605,
  -1246,
  -423,
  494,
  1134,
  1270,
  891,
  183,
  -558,
  -1052,
  -1126,
  -770,
  -112,
  637,
  1269,
  1640,
  1706,
  1513,
  1163,
  772,
  432,
  190,
  52,
  -4,
  -20
};

void LPFilter_init(LPFilter* f) {
  int i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void LPFilter_put(LPFilter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == LPFILTER_TAP_NUM)
    f->last_index = 0;
}

int LPFilter_get(LPFilter* f) {
  int64_t acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : LPFILTER_TAP_NUM-1;
    acc += (int64_t)f->history[index] * filter_taps[i];
  };
  return acc >> 20;
}
