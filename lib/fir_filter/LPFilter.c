#include <stdint.h>
#include "LPFilter.h"

static int filter_taps[LPFILTER_TAP_NUM] = {
  15,
  18,
  -27,
  -136,
  -254,
  -269,
  -115,
  125,
  241,
  95,
  -199,
  -329,
  -97,
  313,
  455,
  89,
  -472,
  -600,
  -35,
  708,
  776,
  -72,
  -1024,
  -956,
  284,
  1468,
  1150,
  -635,
  -2069,
  -1323,
  1244,
  2965,
  1486,
  -2313,
  -4438,
  -1598,
  4635,
  7795,
  1673,
  -13510,
  -29741,
  -36648,
  -29544,
  -13184,
  2037,
  8136,
  4943,
  -1293,
  -4110,
  -1958,
  1853,
  3329,
  1608,
  -948,
  -1674,
  -219,
  1580,
  1909,
  738,
  -486,
  -533,
  441,
  1311,
  1265,
  541,
  -5,
  143,
  731,
  1133,
  1027,
  642,
  417,
  544,
  843,
  1018,
  956,
  780,
  679,
  731,
  875,
  1011,
  1091,
  1131,
  1157,
  1194,
  1226,
  1261,
  1300,
  1343,
  1385,
  1424,
  1462,
  1500,
  1542,
  1586,
  1630,
  1672,
  1712,
  1753,
  1796,
  1843,
  1891,
  1936,
  1976,
  2012,
  2048,
  2089,
  2137,
  2189,
  2240,
  2287,
  2331,
  2373,
  2416,
  2461,
  2507,
  2551,
  2593,
  2635,
  2677,
  2720,
  2763,
  2805,
  2845,
  2885,
  2925,
  2965,
  3005,
  3044,
  3081,
  3117,
  3153,
  3190,
  3227,
  3263,
  3296,
  3326,
  3354,
  3382,
  3412,
  3444,
  3476,
  3505,
  3531,
  3556,
  3579,
  3602,
  3624,
  3645,
  3664,
  3682,
  3698,
  3713,
  3727,
  3740,
  3751,
  3760,
  3768,
  3775,
  3781,
  3785,
  3786,
  3786,
  3784,
  3782,
  3778,
  3773,
  3766,
  3755,
  3741,
  3726,
  3710,
  3693,
  3676,
  3657,
  3635,
  3611,
  3584,
  3555,
  3525,
  3493,
  3458,
  3421,
  3382,
  3341,
  3299,
  3254,
  3206,
  3157,
  3105,
  3051,
  2996,
  2938,
  2878,
  2815,
  2750,
  2682,
  2613,
  2543,
  2470,
  2394,
  2314,
  2232,
  2148,
  2063,
  1976,
  1887,
  1796,
  1702,
  1605,
  1506,
  1404,
  1301,
  1195,
  1087,
  976,
  864,
  749,
  631,
  512,
  390,
  265,
  139,
  10,
  -120,
  -253,
  -388,
  -526,
  -666,
  -808,
  -951,
  -1096,
  -1244,
  -1394,
  -1547,
  -1703,
  -1859,
  -2017,
  -2177,
  -2338,
  -2502,
  -2668,
  -2836,
  -3005,
  -3177,
  -3350,
  -3525,
  -3702,
  -3880,
  -4060,
  -4242,
  -4426,
  -4611,
  -4798,
  -4986,
  -5176,
  -5367,
  -5559,
  -5753,
  -5948,
  -6145,
  -6343,
  -6542,
  -6741,
  -6942,
  -7145,
  -7349,
  -7554,
  -7760,
  -7967,
  -8174,
  -8382,
  -8590,
  -8800,
  -9011,
  -9222,
  -9434,
  -9646,
  -9859,
  -10073,
  -10287,
  -10501,
  -10715,
  -10930,
  -11146,
  -11361,
  -11577,
  -11793,
  -12008,
  -12224,
  -12440,
  -12655,
  -12871,
  -13087,
  -13302,
  -13516,
  -13730,
  -13944,
  -14157,
  -14371,
  -14584,
  -14796,
  -15007,
  -15217,
  -15427,
  -15636,
  -15844,
  -16051,
  -16257,
  -16462,
  -16666,
  -16869,
  -17071,
  -17272,
  -17471,
  -17669,
  -17866,
  -18061,
  -18255,
  -18447,
  -18638,
  -18827,
  -19014,
  -19200,
  -19384,
  -19566,
  -19746,
  -19925,
  -20101,
  -20275,
  -20447,
  -20618,
  -20786,
  -20953,
  -21116,
  -21278,
  -21437,
  -21593,
  -21748,
  -21900,
  -22050,
  -22197,
  -22341,
  -22483,
  -22622,
  -22759,
  -23507,
  -23734,
  -22087,
  -17864,
  -13251,
  -12730,
  -18981,
  -28631,
  -33388,
  -27698,
  -16092,
  -10988,
  -20298,
  -36749,
  -42536,
  -28068,
  -5777,
  -696,
  -23252,
  -52982,
  -55831,
  -22170,
  15770,
  13117,
  -36313,
  -83613,
  -71152,
  -120,
  57147,
  27564,
  -74719,
  -143568,
  -84943,
  66447,
  151504,
  38660,
  -209854,
  -336533,
  -93174,
  512519,
  1161786,
  1440934,
  1161786,
  512519,
  -93174,
  -336533,
  -209854,
  38660,
  151504,
  66447,
  -84943,
  -143568,
  -74719,
  27564,
  57147,
  -120,
  -71152,
  -83613,
  -36313,
  13117,
  15770,
  -22170,
  -55831,
  -52982,
  -23252,
  -696,
  -5777,
  -28068,
  -42536,
  -36749,
  -20298,
  -10988,
  -16092,
  -27698,
  -33388,
  -28631,
  -18981,
  -12730,
  -13251,
  -17864,
  -22087,
  -23734,
  -23507,
  -22759,
  -22622,
  -22483,
  -22341,
  -22197,
  -22050,
  -21900,
  -21748,
  -21593,
  -21437,
  -21278,
  -21116,
  -20953,
  -20786,
  -20618,
  -20447,
  -20275,
  -20101,
  -19925,
  -19746,
  -19566,
  -19384,
  -19200,
  -19014,
  -18827,
  -18638,
  -18447,
  -18255,
  -18061,
  -17866,
  -17669,
  -17471,
  -17272,
  -17071,
  -16869,
  -16666,
  -16462,
  -16257,
  -16051,
  -15844,
  -15636,
  -15427,
  -15217,
  -15007,
  -14796,
  -14584,
  -14371,
  -14157,
  -13944,
  -13730,
  -13516,
  -13302,
  -13087,
  -12871,
  -12655,
  -12440,
  -12224,
  -12008,
  -11793,
  -11577,
  -11361,
  -11146,
  -10930,
  -10715,
  -10501,
  -10287,
  -10073,
  -9859,
  -9646,
  -9434,
  -9222,
  -9011,
  -8800,
  -8590,
  -8382,
  -8174,
  -7967,
  -7760,
  -7554,
  -7349,
  -7145,
  -6942,
  -6741,
  -6542,
  -6343,
  -6145,
  -5948,
  -5753,
  -5559,
  -5367,
  -5176,
  -4986,
  -4798,
  -4611,
  -4426,
  -4242,
  -4060,
  -3880,
  -3702,
  -3525,
  -3350,
  -3177,
  -3005,
  -2836,
  -2668,
  -2502,
  -2338,
  -2177,
  -2017,
  -1859,
  -1703,
  -1547,
  -1394,
  -1244,
  -1096,
  -951,
  -808,
  -666,
  -526,
  -388,
  -253,
  -120,
  10,
  139,
  265,
  390,
  512,
  631,
  749,
  864,
  976,
  1087,
  1195,
  1301,
  1404,
  1506,
  1605,
  1702,
  1796,
  1887,
  1976,
  2063,
  2148,
  2232,
  2314,
  2394,
  2470,
  2543,
  2613,
  2682,
  2750,
  2815,
  2878,
  2938,
  2996,
  3051,
  3105,
  3157,
  3206,
  3254,
  3299,
  3341,
  3382,
  3421,
  3458,
  3493,
  3525,
  3555,
  3584,
  3611,
  3635,
  3657,
  3676,
  3693,
  3710,
  3726,
  3741,
  3755,
  3766,
  3773,
  3778,
  3782,
  3784,
  3786,
  3786,
  3785,
  3781,
  3775,
  3768,
  3760,
  3751,
  3740,
  3727,
  3713,
  3698,
  3682,
  3664,
  3645,
  3624,
  3602,
  3579,
  3556,
  3531,
  3505,
  3476,
  3444,
  3412,
  3382,
  3354,
  3326,
  3296,
  3263,
  3227,
  3190,
  3153,
  3117,
  3081,
  3044,
  3005,
  2965,
  2925,
  2885,
  2845,
  2805,
  2763,
  2720,
  2677,
  2635,
  2593,
  2551,
  2507,
  2461,
  2416,
  2373,
  2331,
  2287,
  2240,
  2189,
  2137,
  2089,
  2048,
  2012,
  1976,
  1936,
  1891,
  1843,
  1796,
  1753,
  1712,
  1672,
  1630,
  1586,
  1542,
  1500,
  1462,
  1424,
  1385,
  1343,
  1300,
  1261,
  1226,
  1194,
  1157,
  1131,
  1091,
  1011,
  875,
  731,
  679,
  780,
  956,
  1018,
  843,
  544,
  417,
  642,
  1027,
  1133,
  731,
  143,
  -5,
  541,
  1265,
  1311,
  441,
  -533,
  -486,
  738,
  1909,
  1580,
  -219,
  -1674,
  -948,
  1608,
  3329,
  1853,
  -1958,
  -4110,
  -1293,
  4943,
  8136,
  2037,
  -13184,
  -29544,
  -36648,
  -29741,
  -13510,
  1673,
  7795,
  4635,
  -1598,
  -4438,
  -2313,
  1486,
  2965,
  1244,
  -1323,
  -2069,
  -635,
  1150,
  1468,
  284,
  -956,
  -1024,
  -72,
  776,
  708,
  -35,
  -600,
  -472,
  89,
  455,
  313,
  -97,
  -329,
  -199,
  95,
  241,
  125,
  -115,
  -269,
  -254,
  -136,
  -27,
  18,
  15
};

void LPFilter_init(LPFilter* f) {
  int i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void LPFilter_put(LPFilter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == LPFILTER_TAP_NUM)
    f->last_index = 0;
}

int LPFilter_get(LPFilter* f) {
  int64_t acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : LPFILTER_TAP_NUM-1;
    acc += (int64_t)f->history[index] * filter_taps[i];
  };
  return acc >> 20;
}
