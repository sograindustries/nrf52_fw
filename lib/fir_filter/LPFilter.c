#include <stdint.h>
#include "LPFilter.h"

static int filter_taps[LPFILTER_TAP_NUM] = {
 5,
119,
141,
101,
-13,
-112,
-97,
30,
149,
124,
-46,
-199,
-161,
65,
262,
204,
-90,
-338,
-254,
125,
430,
310,
-171,
-539,
-372,
230,
669,
437,
-307,
-820,
-507,
403,
995,
578,
-523,
-1195,
-650,
671,
1424,
719,
-852,
-1683,
-783,
1070,
1973,
839,
-1331,
-2298,
-883,
1641,
2659,
909,
-2007,
-3058,
-913,
2438,
3499,
889,
-2944,
-3984,
-828,
3535,
4517,
722,
-4227,
-5105,
-561,
5037,
5753,
330,
-5990,
-6474,
-13,
7118,
7283,
-414,
-8468,
-8203,
983,
10106,
9269,
-1741,
-12136,
-10541,
2762,
14727,
12115,
-4168,
-18169,
-14167,
6181,
23012,
17044,
-9253,
-30440,
-21538,
14476,
43531,
29904,
-25316,
-73585,
-52149,
61887,
222318,
338453,
338453,
222318,
61887,
-52149,
-73585,
-25316,
29904,
43531,
14476,
-21538,
-30440,
-9253,
17044,
23012,
6181,
-14167,
-18169,
-4168,
12115,
14727,
2762,
-10541,
-12136,
-1741,
9269,
10106,
983,
-8203,
-8468,
-414,
7283,
7118,
-13,
-6474,
-5990,
330,
5753,
5037,
-561,
-5105,
-4227,
722,
4517,
3535,
-828,
-3984,
-2944,
889,
3499,
2438,
-913,
-3058,
-2007,
909,
2659,
1641,
-883,
-2298,
-1331,
839,
1973,
1070,
-783,
-1683,
-852,
719,
1424,
671,
-650,
-1195,
-523,
578,
995,
403,
-507,
-820,
-307,
437,
669,
230,
-372,
-539,
-171,
310,
430,
125,
-254,
-338,
-90,
204,
262,
65,
-161,
-199,
-46,
124,
149,
30,
-97,
-112,
-13,
101,
141,
119,
5
};

void LPFilter_init(LPFilter* f) {
  int i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void LPFilter_put(LPFilter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == LPFILTER_TAP_NUM)
    f->last_index = 0;
}

int LPFilter_get(LPFilter* f) {
  int64_t acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < LPFILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : LPFILTER_TAP_NUM-1;
    acc += (int64_t)f->history[index] * filter_taps[i];
  };
  return acc >> 20;
}
